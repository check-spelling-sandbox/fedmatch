<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fuzzy Matching • fedmatch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fuzzy Matching">
<meta property="og:description" content="fedmatch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fedmatch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Fuzzy-matching.html">Fuzzy Matching</a>
    </li>
    <li>
      <a href="../articles/Intro-to-fedmatch.html">Introduction to fedmatch</a>
    </li>
    <li>
      <a href="../articles/Multivar_matching.html">Multivar Matching</a>
    </li>
    <li>
      <a href="../articles/Using-clean-strings.html">Using clean_strings</a>
    </li>
    <li>
      <a href="../articles/Using-tier-match.html">Tier Matching</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Fuzzy-matching_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fuzzy Matching</h1>
            
      
      
      <div class="hidden name"><code>Fuzzy-matching.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">fedmatch</span><span class="op">)</span></code></pre></div>
<div id="intro" class="section level1">
<h1 class="hasAnchor">
<a href="#intro" class="anchor"></a>Intro</h1>
<p>Fuzzy matching is an essential part of the matching process. After trying all the name cleaning that you can with <code>clean_strings</code>, you have gotten the ‘low hanging fruit’ of your match, and now you need to move on to non-exact matches. <code>merge_plus</code> has a built-in setting for this called ‘fuzzy’ matching. It lets you match on strings that are similar, but not exactly the same.</p>
</div>
<div id="fuzzy-matching-theory" class="section level1">
<h1 class="hasAnchor">
<a href="#fuzzy-matching-theory" class="anchor"></a>Fuzzy matching theory</h1>
<p>The basic idea behind fuzzy matching is to compute a numerical ‘distance’ between every potential string comparison, and then for each string in data set 1, pick the ‘closest’ string in data set 2. One can also specify a threshold such that every match is of a certain quality. The concept of ‘distance’ can be defined in several methods, explained below. Each method will define a similarity <span class="math inline">\(s\)</span>, <span class="math inline">\(0 \leq s \leq 1\)</span> , such that higher values will mean the strings are more similar, and a corresponding distance <span class="math inline">\(d = 1 - s\)</span>.</p>
<div id="jaro-winkler" class="section level2">
<h2 class="hasAnchor">
<a href="#jaro-winkler" class="anchor"></a>Jaro-Winkler</h2>
<p>The most common method of matching strings with <code>fedmatch</code> uses the Jaro-Winkler string distance. The Jaro similarity is defined as</p>
<p><span class="math display">\[s_j = \begin{cases} 0 &amp;  \text{if } m = 0 \\ \frac{1}{3} \left(\frac{m}{|s_1|} + \frac{m}{|s_2|} + \frac{m - t}{m} \right) &amp; \text{otherwise} \end{cases}\]</span></p>
<p>where <span class="math inline">\(|s_i|\)</span> is the length of the <span class="math inline">\(i\)</span>th string, <span class="math inline">\(m\)</span> is the number of characters that match, and <span class="math inline">\(t\)</span> is the number of transpositions (the number of letters to be interchanged to place them in the proper order.) For example, if <span class="math inline">\(s_1\)</span> is “abcd” and <span class="math inline">\(s_2\)</span> is “acbd”, then the number of transpositions is 1, the matching characters are 4, and the similarity is <span class="math inline">\(\frac{1}{3}\left( 1 + 1 + \frac{3}{4} \right) \approx .917\)</span>.</p>
<p>Winkler’s modification to this similarity is to weight the start of the strings more heavily. Thus, if the strings share a common prefix, the similarity will be higher. The Jaro-Winkler similarity is</p>
<p><span class="math display">\[s_w = s_j + l p (1-s_j),\]</span></p>
<p>where <span class="math inline">\(l\)</span> is the shared prefix length (up to four characters, so <span class="math inline">\(0 \leq l \leq 4\)</span> ), and <span class="math inline">\(p\)</span> is just user-defined constant, <span class="math inline">\(0 &lt; p \leq .25\)</span>, that defines how heavily to weight the shared prefix. <span class="math inline">\(p=.1\)</span> is the default used by <code>fedmatch</code>.</p>
</div>
<div id="weighted-jaccard-similarity" class="section level2">
<h2 class="hasAnchor">
<a href="#weighted-jaccard-similarity" class="anchor"></a>Weighted Jaccard Similarity</h2>
<p>Another string distance metric is called the Jaccard Similarity. If <span class="math inline">\(A\)</span> is the set of letters in one string, and <span class="math inline">\(B\)</span> is the set of letters in another string, then the Jaccard similarity <span class="math inline">\(J\)</span> is defined as</p>
<p><span class="math display">\[J = \frac{A \bigcap B}{A \bigcup B}.\]</span></p>
<p>Thus, if the two strings share all of the same letters, then the distance is 0, or the similarity is 1.</p>
<p>We take one step further and innovate to create a new measure of string distance, which we call the <em>Weighted Jaccard</em> distance. Rather than looking at the sets of letters in each string, we look at the set of words in each string. Then, we construct a corpus of all of the words in the two columns to be matched and compute the log inverse frequency for each word:</p>
<p><span class="math display">\[w_i = \log \left( \frac{N}{n_i} \right), \]</span> where <span class="math inline">\(N\)</span> is the total number of unique words in the sample, and <span class="math inline">\(n_i\)</span> is the number of occurences of word <span class="math inline">\(i\)</span> in the sample.</p>
<p>For example, the word ‘Corporation’ appears frequently in the names of companies in common data sets, and so its log inverse frequency would be low. But, the word ‘Apple’ probably only appears in a few company names out of the many thousands in the data, so its log inverse frequency score would be high.</p>
<p>If these logged inverse frequencies are called <span class="math inline">\(w\)</span>, then the Weighted Jaccard similarity is computed as</p>
<p><span class="math display">\[ J_i = \frac{ \sum_j w_j,  j \in A \bigcap B}{ \sum_k w_k, k \in A \bigcup B} \]</span></p>
<p>Thus, if the two strings share many words that are uniquely identifying in the corpus, the Weighted Jaccard similarity will be higher. We have found this method of matching is able to pick up many more matches when used in conjunction with the Jaro-Winkler distance. To our knowledge, such a Weighted Jaccard method has never been used before, and is one of the key innovations that makes <code>fedmatch</code> unique.<br></p>
</div>
<div id="other-similarity-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#other-similarity-metrics" class="anchor"></a>Other similarity metrics</h2>
<p>Because fedmatch uses <code><a href="https://rdrr.io/pkg/stringdist/man/amatch.html">stringdist::amatch</a></code> for all other options, one can use any of the similarity metrics listed in the documentation for that function in fedmatch.</p>
</div>
</div>
<div id="using-fuzzy-matching-in-fedmatch" class="section level1">
<h1 class="hasAnchor">
<a href="#using-fuzzy-matching-in-fedmatch" class="anchor"></a>Using fuzzy matching in fedmatch</h1>
<div id="basic-syntax" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-syntax" class="anchor"></a>Basic Syntax</h2>
<p>As shown in the ‘Intro to fedmatch’ vignette, the basic syntax of using fuzzy match is just the same as exact matching, but changing the ‘match_type’ argument in <code>merge_plus</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fuzzy_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_plus.html">merge_plus</a></span><span class="op">(</span>data1 <span class="op">=</span> <span class="va">corp_data1</span>, 
                          data2 <span class="op">=</span> <span class="va">corp_data2</span>,
                          by.x <span class="op">=</span> <span class="st">"Company"</span>,
                          by.y <span class="op">=</span> <span class="st">"Name"</span>, match_type <span class="op">=</span> <span class="st">"fuzzy"</span>, 
                          unique_key_1 <span class="op">=</span> <span class="st">"unique_key_1"</span>,
                          unique_key_2 <span class="op">=</span> <span class="st">"unique_key_2"</span><span class="op">)</span>
<span class="co">#&gt; Fuzzy matching despite exact matches in the data. Consider removing these exact matches to dramatically speed up the matching process and improve consistency.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fuzzy_result</span><span class="op">$</span><span class="va">matches</span><span class="op">)</span>
<span class="co">#&gt;    unique_key_2 unique_key_1 Country State  SIC Revenue            Company</span>
<span class="co">#&gt; 1:            1            1     USA    OH 3300     485            Walmart</span>
<span class="co">#&gt; 2:            2            2     USA       2222     223   Bershire Hataway</span>
<span class="co">#&gt; 3:            6            6     USA    MA   NA     184 UnitedHealth Group</span>
<span class="co">#&gt;                  Name country state_code SIC_code earnings tier</span>
<span class="co">#&gt; 1:            Walmart     USA         OH     3380  490,000  all</span>
<span class="co">#&gt; 2:  Bershire Hathaway     USA         NE     2220  220,000  all</span>
<span class="co">#&gt; 3: UnitedHealth Group     USA         MA     1130  180,000  all</span></code></pre></div>
<p>Note that ‘Bershire Hathaway’ matched to ‘Bershire Hataway,’ which makes sense - the names are only off by one character. All of the settings of fuzzy matching are controlled in the ‘fuzzy_settings’ argument of <code>merge_plus</code>, and these settings can be easily modified with the function <code>build_fuzzy_settings</code>. <code>build_fuzzy_settings</code> returns a list that is properly formatted for <code>merge_plus</code>.The options and their defaults are:</p>
<ul>
<li>
<code>method</code> , default “jw”, determines the string distance metric to use.</li>
<li>
<code>p</code> , default 0.1, is a numeric vector of length 1, that determines the factor <span class="math inline">\(p\)</span> in the Jaro-Winkler string distance. Only used if <code>method == "jw"</code>.</li>
<li>maxDist, default 0.05, is a numeric vector of length 1 that determines the maximum allowable string distance that qualifies as a match.</li>
<li>matchNA, default <code>FALSE</code>, is a boolean to determine whether to count NAs as a match (see <code><a href="https://rdrr.io/pkg/stringdist/man/amatch.html">stringdist::amatch</a></code> for details.)</li>
<li>nthread, number of threads to use in the underlying C code. If using any method besides “wgt_jaccard”, uses `stringdist::amatch’ to parallelize. If using “wgt_jaccard”, instead uses built in C++ code to parallelize.</li>
</ul>
</div>
<div id="an-example---weighted-jaccard-match" class="section level2">
<h2 class="hasAnchor">
<a href="#an-example---weighted-jaccard-match" class="anchor"></a>An example - weighted Jaccard match</h2>
<div id="weighted-jaccard-match" class="section level3">
<h3 class="hasAnchor">
<a href="#weighted-jaccard-match" class="anchor"></a>Weighted Jaccard Match</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wgt_jaccard_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_plus.html">merge_plus</a></span><span class="op">(</span>data1 <span class="op">=</span> <span class="va">corp_data1</span>, 
                          data2 <span class="op">=</span> <span class="va">corp_data2</span>,
                          by.x <span class="op">=</span> <span class="st">"Company"</span>,
                          by.y <span class="op">=</span> <span class="st">"Name"</span>, match_type <span class="op">=</span> <span class="st">"fuzzy"</span>, 
                          fuzzy_settings <span class="op">=</span> <span class="fu"><a href="../reference/build_fuzzy_settings.html">build_fuzzy_settings</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"wgt_jaccard"</span>, nthread <span class="op">=</span> <span class="fl">2</span>,
                                                                maxDist <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,
                          unique_key_1 <span class="op">=</span> <span class="st">"unique_key_1"</span>,
                          unique_key_2 <span class="op">=</span> <span class="st">"unique_key_2"</span><span class="op">)</span>
<span class="co">#&gt; Fuzzy matching despite exact matches in the data. Consider removing these exact matches to dramatically speed up the matching process and improve consistency.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">wgt_jaccard_match</span><span class="op">)</span>
<span class="co">#&gt; $matches</span>
<span class="co">#&gt;    unique_key_2 unique_key_1 Country State  SIC Revenue            Company</span>
<span class="co">#&gt; 1:            1            1     USA    OH 3300     485            Walmart</span>
<span class="co">#&gt; 2:            4            4     USA    TX 2222     205       Exxon Mobile</span>
<span class="co">#&gt; 3:            6            6     USA    MA   NA     184 UnitedHealth Group</span>
<span class="co">#&gt; 4:           10           10     USA    MI   NA     151 Ford Motor Company</span>
<span class="co">#&gt;                  Name wgt_jaccard_sim country state_code SIC_code earnings tier</span>
<span class="co">#&gt; 1:            Walmart       1.0000000     USA         OH     3380  490,000  all</span>
<span class="co">#&gt; 2: Exxon Mobile Inc.        0.6173197     USA         TX     2222  210,000  all</span>
<span class="co">#&gt; 3: UnitedHealth Group       1.0000000     USA         MA     1130  180,000  all</span>
<span class="co">#&gt; 4:         Ford Motor       0.6173197     USA         MI     2222  150,000  all</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $matches_filter</span>
<span class="co">#&gt; Null data.table (0 rows and 0 cols)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $data1_nomatch</span>
<span class="co">#&gt;             Company Country State  SIC Revenue unique_key_1</span>
<span class="co">#&gt; 1: Bershire Hataway     USA       2222     223            2</span>
<span class="co">#&gt; 2:            Apple     USA    CA 3384     215            3</span>
<span class="co">#&gt; 3:        McKesson  Germany    MA  222     192            5</span>
<span class="co">#&gt; 4:       CVS Health     USA    RI 1112     177            7</span>
<span class="co">#&gt; 5:   General Motors     USA    MI 2222     166            8</span>
<span class="co">#&gt; 6:             AT&amp;T     USA    TN 4000     163            9</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $data2_nomatch</span>
<span class="co">#&gt;                 Name country state_code SIC_code earnings unique_key_2</span>
<span class="co">#&gt; 1: Bershire Hathaway     USA         NE     2220  220,000            2</span>
<span class="co">#&gt; 2:    Apple Computer     USA         CA       NA  220,000            3</span>
<span class="co">#&gt; 3:    McKesson Corp.                 MA     2222  190,000            5</span>
<span class="co">#&gt; 4:               CVS                 RI     1122  180,000            7</span>
<span class="co">#&gt; 5:                GM                 MI     2222  170,000            8</span>
<span class="co">#&gt; 6:            AT &amp; T     USA         TN     4000  160,000            9</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $match_evaluation</span>
<span class="co">#&gt;    tier matches in_tier_unique_1 in_tier_unique_2 pct_matched_1 pct_matched_2</span>
<span class="co">#&gt; 1:  all       4                4                4           0.4           0.4</span>
<span class="co">#&gt;    new_unique_1 new_unique_2</span>
<span class="co">#&gt; 1:            4            4</span></code></pre></div>
<p>Note that we have an extra column, ‘wgt_jaccard_sim’, that shows the similarity score for the weighted Jaccard method.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Melanie Friedrichs, Chris Webster, Blake Marsh, Jacob Dice, Seung Lee.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
