<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Chris Webster" />


<title>Introduction to fedmatch: merge_plus</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to fedmatch: merge_plus</h1>
<h4 class="author">Chris Webster</h4>



<div id="background" class="section level1">
<h1>Background</h1>
<p><code>fedmatch</code> is a set of tools for performing record linkage between two data sets, developed by a team of matching enthusiasts at the Federal Reserve (hence the <code>fed</code> in <code>fedmatch</code>.) It allows for a variety of different matching techniques, letting the user build a matching algorithm for their specific application. Nothing here is cutting edge or particularly mind-blowing. Rather, <code>fedmatch</code> is intended to be a solid set of tools that is easily usable to perform the basic functions of record linkage.</p>
<p>This vignette will explain the <code>merge_plus</code> function, which is the core function of <code>fedmatch</code>.</p>
</div>
<div id="basics-merge_plus" class="section level1">
<h1>Basics: <code>merge_plus</code></h1>
<p>The workhorse of <code>fedmatch</code> is <code>merge_plus</code>. <code>merge_plus</code> is an extremely flexible function that can perform several different types of matches: exact, fuzzy, and multivar.</p>
<div id="exact-matching" class="section level2">
<h2>Exact matching</h2>
<p>Here are the example datasets that come with fedmatch:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>fedmatch<span class="op">::</span>corp_data1</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#&gt;                Company Country State  SIC Revenue unique_key_1</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#&gt;  1:            Walmart     USA    OH 3300     485            1</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt;  2:   Bershire Hataway     USA       2222     223            2</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&gt;  3:              Apple     USA    CA 3384     215            3</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&gt;  4:       Exxon Mobile     USA    TX 2222     205            4</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt;  5:          McKesson  Germany    MA  222     192            5</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt;  6: UnitedHealth Group     USA    MA   NA     184            6</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt;  7:         CVS Health     USA    RI 1112     177            7</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt;  8:     General Motors     USA    MI 2222     166            8</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt;  9:               AT&amp;T     USA    TN 4000     163            9</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt; 10: Ford Motor Company     USA    MI   NA     151           10</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>fedmatch<span class="op">::</span>corp_data2</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">#&gt;                   Name country state_code SIC_code earnings unique_key_2</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co">#&gt;  1:            Walmart     USA         OH     3380  490,000            1</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">#&gt;  2:  Bershire Hathaway     USA         NE     2220  220,000            2</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co">#&gt;  3:     Apple Computer     USA         CA       NA  220,000            3</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">#&gt;  4: Exxon Mobile Inc.      USA         TX     2222  210,000            4</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">#&gt;  5:     McKesson Corp.                 MA     2222  190,000            5</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">#&gt;  6: UnitedHealth Group     USA         MA     1130  180,000            6</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co">#&gt;  7:                CVS                 RI     1122  180,000            7</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">#&gt;  8:                 GM                 MI     2222  170,000            8</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">#&gt;  9:             AT &amp; T     USA         TN     4000  160,000            9</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">#&gt; 10:         Ford Motor     USA         MI     2222  150,000           10</span></span></code></pre></div>
<p>The most basic way to use <code>merge_plus</code> is by simply making it equivalent to <code>base::merge</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>basic_merge &lt;-<span class="st"> </span><span class="kw">merge_plus</span>(<span class="dt">data1 =</span> corp_data1, </span>
<span id="cb2-2"><a href="#cb2-2"></a>                          <span class="dt">data2 =</span> corp_data2,</span>
<span id="cb2-3"><a href="#cb2-3"></a>                          <span class="dt">by.x =</span> <span class="st">&quot;Company&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>                          <span class="dt">by.y =</span> <span class="st">&quot;Name&quot;</span>, <span class="dt">match_type =</span> <span class="st">&quot;exact&quot;</span>, </span>
<span id="cb2-5"><a href="#cb2-5"></a>                          <span class="dt">unique_key_1 =</span> <span class="st">&quot;unique_key_1&quot;</span>,</span>
<span id="cb2-6"><a href="#cb2-6"></a>                          <span class="dt">unique_key_2 =</span> <span class="st">&quot;unique_key_2&quot;</span>)</span></code></pre></div>
<p>This code will run merge on the “Company” and “Name” variables, and return cases where the two have an exact match. The only differences between this and <code>base::merge</code> are</p>
<ol style="list-style-type: decimal">
<li><code>merge_plus</code> requires data1 and data2 each to have a “unique key” that can be used to identify an observation.</li>
<li><code>merge_plus</code> returns a list.</li>
</ol>
<p>Let’s take a look at each of the elements of the list returned by <code>merge_plus</code>. These will always be the same, no matter which <code>match_type</code> you select in <code>merge_plus</code>.</p>
<p>The first item is the matches themselves. This is a <code>data.table</code> with one row for each matching observation, along with all variables present in each data set.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">print</span>(basic_merge<span class="op">$</span>matches)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#&gt;               Company Country State  SIC Revenue unique_key_1 country</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&gt; 1:            Walmart     USA    OH 3300     485            1     USA</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&gt; 2: UnitedHealth Group     USA    MA   NA     184            6     USA</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&gt;    state_code SIC_code earnings unique_key_2 tier</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#&gt; 1:         OH     3380  490,000            1  all</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&gt; 2:         MA     1130  180,000            6  all</span></span></code></pre></div>
<p>The next item is <code>matches_filter</code>. In this example, it’s empty, because we didn’t supply the argument <code>filter</code>. If we did supply <code>filter</code> (which can either be a function that filters, or a numeric cutoff for a matchscore (more on this later)), we would see a subsample of the matches dataset.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">print</span>(basic_merge<span class="op">$</span>matches_filter)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; Null data.table (0 rows and 0 cols)</span></span></code></pre></div>
<p>Next in the list is <code>data1_nomatch</code> and <code>data2_nomatch</code>, which return the rows that were not matched from the datasets.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">print</span>(basic_merge<span class="op">$</span>data1_nomatch)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#&gt;               Company Country State  SIC Revenue unique_key_1</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">#&gt; 1:   Bershire Hataway     USA       2222     223            2</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#&gt; 2:              Apple     USA    CA 3384     215            3</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">#&gt; 3:       Exxon Mobile     USA    TX 2222     205            4</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">#&gt; 4:          McKesson  Germany    MA  222     192            5</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&gt; 5:         CVS Health     USA    RI 1112     177            7</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#&gt; 6:     General Motors     USA    MI 2222     166            8</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#&gt; 7:               AT&amp;T     USA    TN 4000     163            9</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">#&gt; 8: Ford Motor Company     USA    MI   NA     151           10</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">print</span>(basic_merge<span class="op">$</span>data2_nomatch)</span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co">#&gt;                  Name country state_code SIC_code earnings unique_key_2</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#&gt; 1:  Bershire Hathaway     USA         NE     2220  220,000            2</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co">#&gt; 2:     Apple Computer     USA         CA       NA  220,000            3</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt; 3: Exxon Mobile Inc.      USA         TX     2222  210,000            4</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co">#&gt; 4:     McKesson Corp.                 MA     2222  190,000            5</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">#&gt; 5:                CVS                 RI     1122  180,000            7</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co">#&gt; 6:                 GM                 MI     2222  170,000            8</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">#&gt; 7:             AT &amp; T     USA         TN     4000  160,000            9</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">#&gt; 8:         Ford Motor     USA         MI     2222  150,000           10</span></span></code></pre></div>
<p>Finally, there is <code>match_evaluation</code>, which is a data.table that summarizes how well the match worked. It shows the number of matches in each dataset broken down by tier (more on tiers later), along with the percent matched.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">print</span>(basic_merge<span class="op">$</span>match_evaluation)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#&gt;    tier matches in_tier_unique_1 in_tier_unique_2 pct_matched_1 pct_matched_2</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt; 1:  all       2                2                2           0.2           0.2</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt;    new_unique_1 new_unique_2</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt; 1:            2            2</span></span></code></pre></div>
</div>
<div id="fuzzy-matching" class="section level2">
<h2>Fuzzy matching</h2>
<p>We can also use <code>merge_plus</code> to perform “fuzzy” matches. A fuzzy match uses a string distance algorithm to compute the distance between one string and a set of other strings, then picks the closest string that’s over a certain threshold. <code>fedmatch</code> uses <code>stringdist::amatch</code> to execute these matches, and you can read more about string distances in the <code>stringdist</code> package documentation.</p>
<p>Here is an example of how this is implemented in <code>merge_plus</code>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>fuzzy_result &lt;-<span class="st"> </span><span class="kw">merge_plus</span>(<span class="dt">data1 =</span> corp_data1, </span>
<span id="cb7-2"><a href="#cb7-2"></a>                          <span class="dt">data2 =</span> corp_data2,</span>
<span id="cb7-3"><a href="#cb7-3"></a>                          <span class="dt">by.x =</span> <span class="st">&quot;Company&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>                          <span class="dt">by.y =</span> <span class="st">&quot;Name&quot;</span>, <span class="dt">match_type =</span> <span class="st">&quot;fuzzy&quot;</span>, </span>
<span id="cb7-5"><a href="#cb7-5"></a>                          <span class="dt">unique_key_1 =</span> <span class="st">&quot;unique_key_1&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>                          <span class="dt">unique_key_2 =</span> <span class="st">&quot;unique_key_2&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="kw">print</span>(fuzzy_result<span class="op">$</span>matches)</span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt;    unique_key_2 unique_key_1 Country State  SIC Revenue            Company</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt; 1:            1            1     USA    OH 3300     485            Walmart</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&gt; 2:            2            2     USA       2222     223   Bershire Hataway</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#&gt; 3:            6            6     USA    MA   NA     184 UnitedHealth Group</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#&gt;                  Name country state_code SIC_code earnings tier</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#&gt; 1:            Walmart     USA         OH     3380  490,000  all</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#&gt; 2:  Bershire Hathaway     USA         NE     2220  220,000  all</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#&gt; 3: UnitedHealth Group     USA         MA     1130  180,000  all</span></span></code></pre></div>
<p>We can see that we picked up an additional match here: “Bershire Hataway” and “Bershire Hathaway.” These are off by 1 character, so the exact match didn’t pick them up, but the fuzzy match did. We can also tweak the fuzzy match settings with the argument <code>fuzzy_settings</code>. This is a list that will be passed to <code>stringdist::amatch</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>fuzzy_result &lt;-<span class="st"> </span><span class="kw">merge_plus</span>(<span class="dt">data1 =</span> corp_data1, </span>
<span id="cb8-2"><a href="#cb8-2"></a>                          <span class="dt">data2 =</span> corp_data2,</span>
<span id="cb8-3"><a href="#cb8-3"></a>                          <span class="dt">by.x =</span> <span class="st">&quot;Company&quot;</span>,</span>
<span id="cb8-4"><a href="#cb8-4"></a>                          <span class="dt">by.y =</span> <span class="st">&quot;Name&quot;</span>, <span class="dt">match_type =</span> <span class="st">&quot;fuzzy&quot;</span>, </span>
<span id="cb8-5"><a href="#cb8-5"></a>                          <span class="dt">fuzzy_settings =</span> <span class="kw">list</span>(<span class="dt">maxDist =</span> <span class="fl">.5</span>, <span class="dt">method =</span> <span class="st">&quot;jw&quot;</span>),</span>
<span id="cb8-6"><a href="#cb8-6"></a>                          <span class="dt">unique_key_1 =</span> <span class="st">&quot;unique_key_1&quot;</span>,</span>
<span id="cb8-7"><a href="#cb8-7"></a>                          <span class="dt">unique_key_2 =</span> <span class="st">&quot;unique_key_2&quot;</span>)</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">print</span>(fuzzy_result<span class="op">$</span>matches)</span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt;     unique_key_2 unique_key_1 Country State  SIC Revenue            Company</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">#&gt;  1:            1            1     USA    OH 3300     485            Walmart</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">#&gt;  2:            2            2     USA       2222     223   Bershire Hataway</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co">#&gt;  3:            3            3     USA    CA 3384     215              Apple</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="co">#&gt;  4:            4            4     USA    TX 2222     205       Exxon Mobile</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co">#&gt;  5:            5            5 Germany    MA  222     192          McKesson </span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="co">#&gt;  6:            6            6     USA    MA   NA     184 UnitedHealth Group</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co">#&gt;  7:            7            7     USA    RI 1112     177         CVS Health</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co">#&gt;  8:            9            9     USA    TN 4000     163               AT&amp;T</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="co">#&gt;  9:           10            8     USA    MI 2222     166     General Motors</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="co">#&gt; 10:           10           10     USA    MI   NA     151 Ford Motor Company</span></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="co">#&gt;                   Name country state_code SIC_code earnings tier</span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="co">#&gt;  1:            Walmart     USA         OH     3380  490,000  all</span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="co">#&gt;  2:  Bershire Hathaway     USA         NE     2220  220,000  all</span></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="co">#&gt;  3:     Apple Computer     USA         CA       NA  220,000  all</span></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="co">#&gt;  4: Exxon Mobile Inc.      USA         TX     2222  210,000  all</span></span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="co">#&gt;  5:     McKesson Corp.                 MA     2222  190,000  all</span></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="co">#&gt;  6: UnitedHealth Group     USA         MA     1130  180,000  all</span></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co">#&gt;  7:                CVS                 RI     1122  180,000  all</span></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="co">#&gt;  8:             AT &amp; T     USA         TN     4000  160,000  all</span></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="co">#&gt;  9:         Ford Motor     USA         MI     2222  150,000  all</span></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="co">#&gt; 10:         Ford Motor     USA         MI     2222  150,000  all</span></span></code></pre></div>
<p>So, cranking up the <code>maxDist</code> (maximum distance between strings, a threshold for determining matches) gave us a bunch more matches. Note that we return multiple matches per the same unique key sometimes, for example Ford Motor got matched to General Motors and Ford Motor Company. There are many tweaks that one can make via <code>fuzzy_settings</code>, and these change the match behavior significantly. It is worth exploring various options to see which make the most sense for your specific application.</p>
</div>
<div id="multivar-matching" class="section level2">
<h2>Multivar matching</h2>
<p>The final setting for <code>match_type</code> in <code>merge_plus</code> is a “multivariable match”, or “multivar” for short. This match is complex, and may take some playing around with the code to fully understand how it works. We’ll just go over the basic usage here. The idea behind the multivariable match is to use several variables from each dataset to execute a match, rather than just using the name of an entity.</p>
<p>One way is to take the set of variables (say, company name, state, and earnings), compare them with some numeric metric, and then perform a linear combination of those metrics to arrive at a final score. Then, you can compare each observation in one dataset to each other observation in the other dataset to pick the match with the highest score.</p>
<p>The other way is similar, but instead of a linear combination of scores, you can use a logit model. In this method, you create a hand-verified match set between your two datasets, then use a logit model to estimate how much each variable contributes to determining a match.</p>
<p>Here’s an example of the first method, the linear combination:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># for simplicity&#39;s sake, rename columns in corp_data2</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="kw">setnames</span>(corp_data2, <span class="kw">c</span>(<span class="st">&quot;Name&quot;</span>, <span class="st">&quot;country&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;Company&quot;</span>, <span class="st">&quot;Country&quot;</span>))</span>
<span id="cb9-3"><a href="#cb9-3"></a>multivar_linear_result &lt;-<span class="st"> </span><span class="kw">merge_plus</span>(corp_data1, corp_data2, </span>
<span id="cb9-4"><a href="#cb9-4"></a>                                     <span class="dt">match_type =</span> <span class="st">&quot;multivar&quot;</span>,</span>
<span id="cb9-5"><a href="#cb9-5"></a>                                     <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;Country&quot;</span>, <span class="st">&quot;Company&quot;</span>), </span>
<span id="cb9-6"><a href="#cb9-6"></a>                                     <span class="dt">unique_key_1 =</span> <span class="st">&quot;unique_key_1&quot;</span>,</span>
<span id="cb9-7"><a href="#cb9-7"></a>                                     <span class="dt">suffixes =</span> <span class="kw">c</span>(<span class="st">&quot;_1&quot;</span>, <span class="st">&quot;_2&quot;</span>),</span>
<span id="cb9-8"><a href="#cb9-8"></a>                                     <span class="dt">unique_key_2 =</span> <span class="st">&quot;unique_key_2&quot;</span>,</span>
<span id="cb9-9"><a href="#cb9-9"></a>                                    </span>
<span id="cb9-10"><a href="#cb9-10"></a>                                     <span class="dt">multivar_settings =</span> <span class="kw">list</span>(<span class="dt">compare_type =</span> <span class="kw">c</span>(<span class="st">&quot;indicator&quot;</span>, <span class="st">&quot;stringdist&quot;</span>),</span>
<span id="cb9-11"><a href="#cb9-11"></a>                                                               <span class="dt">wgts =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.5</span>),</span>
<span id="cb9-12"><a href="#cb9-12"></a>                                                              <span class="dt">top =</span> <span class="dv">1</span>))</span>
<span id="cb9-13"><a href="#cb9-13"></a>multivar_linear_result<span class="op">$</span>matches                                     </span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co">#&gt;     unique_key_1          Company_1 Country_1 State  SIC Revenue</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co">#&gt;  1:            1            Walmart       USA    OH 3300     485</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="co">#&gt;  2:            2   Bershire Hataway       USA       2222     223</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="co">#&gt;  3:            3              Apple       USA    CA 3384     215</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="co">#&gt;  4:            4       Exxon Mobile       USA    TX 2222     205</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="co">#&gt;  5:            5          McKesson    Germany    MA  222     192</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co">#&gt;  6:            6 UnitedHealth Group       USA    MA   NA     184</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="co">#&gt;  7:            7         CVS Health       USA    RI 1112     177</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="co">#&gt;  8:            9               AT&amp;T       USA    TN 4000     163</span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="co">#&gt;  9:            8     General Motors       USA    MI 2222     166</span></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="co">#&gt; 10:           10 Ford Motor Company       USA    MI   NA     151</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="co">#&gt;              Company_2 Country_2 state_code SIC_code earnings unique_key_2</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="co">#&gt;  1:            Walmart       USA         OH     3380  490,000            1</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="co">#&gt;  2:  Bershire Hathaway       USA         NE     2220  220,000            2</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="co">#&gt;  3:     Apple Computer       USA         CA       NA  220,000            3</span></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="co">#&gt;  4: Exxon Mobile Inc.        USA         TX     2222  210,000            4</span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="co">#&gt;  5:     McKesson Corp.                   MA     2222  190,000            5</span></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="co">#&gt;  6: UnitedHealth Group       USA         MA     1130  180,000            6</span></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="co">#&gt;  7: UnitedHealth Group       USA         MA     1130  180,000            6</span></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="co">#&gt;  8:             AT &amp; T       USA         TN     4000  160,000            9</span></span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="co">#&gt;  9:         Ford Motor       USA         MI     2222  150,000           10</span></span>
<span id="cb9-35"><a href="#cb9-35"></a><span class="co">#&gt; 10:         Ford Motor       USA         MI     2222  150,000           10</span></span>
<span id="cb9-36"><a href="#cb9-36"></a><span class="co">#&gt;     Country_compare Company_compare matchscore tier</span></span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="co">#&gt;  1:               1       1.0000000  1.0000000  all</span></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="co">#&gt;  2:               1       0.9882353  0.9941176  all</span></span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="co">#&gt;  3:               1       0.8714286  0.9357143  all</span></span>
<span id="cb9-40"><a href="#cb9-40"></a><span class="co">#&gt;  4:               1       0.9333333  0.9666667  all</span></span>
<span id="cb9-41"><a href="#cb9-41"></a><span class="co">#&gt;  5:               0       0.9285714  0.4642857  all</span></span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="co">#&gt;  6:               1       1.0000000  1.0000000  all</span></span>
<span id="cb9-43"><a href="#cb9-43"></a><span class="co">#&gt;  7:               1       0.5333333  0.7666667  all</span></span>
<span id="cb9-44"><a href="#cb9-44"></a><span class="co">#&gt;  8:               1       0.9111111  0.9555556  all</span></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="co">#&gt;  9:               1       0.7333333  0.8666667  all</span></span>
<span id="cb9-46"><a href="#cb9-46"></a><span class="co">#&gt; 10:               1       0.9111111  0.9555556  all</span></span></code></pre></div>
<p>To specify this type of match, we put in the <code>match_type</code> as “multivar,” and then we specified how we wanted the match to run by passing the list <code>multivar_settings</code>. Each element of this list is a separate argument to go into <code>multivar_match</code>. The <code>compare_type</code> argument tells the multivar how to compare each variable in the <code>by</code> argument. Because “Country” is a binary variable, we specify “indicator”, and because “Company” is a string variable, we specify “stringdist.” You can see a full list of options for comparison in the <code>multivar_match</code> documentation, or equivalently, the <code>merge_plus</code> <code>score_settings</code> documentation. (<code>merge_plus</code> has an option to compute matchscores post-hoc, as a method of evaluation.)</p>
<p>Next, here’s an example the second method, using a logit model. First, we’ll set up a fake training table. Normally, one would construct a human-verified match set. Here, I just create a table where the first half are matches, the second half are a mix of matches and not, and then the two comparison variables are biased to be more of a match in the first half of the sample. This is just a way to ensure that our logit model gives us positive coefficients, so that our example makes a little more sense.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">set.seed</span>(<span class="dv">111</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a>training_table &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">match =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="fl">5e4</span>), <span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span> ), <span class="fl">5e4</span>, <span class="dt">replace =</span> T)),</span>
<span id="cb10-3"><a href="#cb10-3"></a>                                <span class="dt">Company_compare =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="fl">0.00001</span>, <span class="fl">-.00001</span>),</span>
<span id="cb10-4"><a href="#cb10-4"></a>                                <span class="dt">Country_compare =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="fl">5e4</span>), <span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="fl">5e4</span>, <span class="dt">replace =</span> T)))</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># training_table</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>logit_model &lt;-<span class="st"> </span><span class="kw">glm</span>(match <span class="op">~</span><span class="st"> </span>Company_compare <span class="op">+</span><span class="st"> </span>Country_compare, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb10-7"><a href="#cb10-7"></a>                   <span class="dt">data =</span> training_table)</span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="kw">summary</span>(logit_model)</span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">#&gt; </span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&gt; Call:</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#&gt; glm(formula = match ~ Company_compare + Country_compare, family = &quot;binomial&quot;, </span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="co">#&gt;     data = training_table)</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co">#&gt; </span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co">#&gt; Deviance Residuals: </span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">#&gt; -1.9655  -0.7099   0.3077   0.5579   1.7452  </span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="co">#&gt; </span></span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="co">#&gt;                 Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="co">#&gt; (Intercept)     -1.27701    0.01702  -75.04   &lt;2e-16 ***</span></span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="co">#&gt; Company_compare  4.98075    0.04134  120.49   &lt;2e-16 ***</span></span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="co">#&gt; Country_compare  0.56183    0.01821   30.85   &lt;2e-16 ***</span></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="co">#&gt; ---</span></span>
<span id="cb10-24"><a href="#cb10-24"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb10-25"><a href="#cb10-25"></a><span class="co">#&gt; </span></span>
<span id="cb10-26"><a href="#cb10-26"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb10-27"><a href="#cb10-27"></a><span class="co">#&gt; </span></span>
<span id="cb10-28"><a href="#cb10-28"></a><span class="co">#&gt;     Null deviance: 112745  on 99999  degrees of freedom</span></span>
<span id="cb10-29"><a href="#cb10-29"></a><span class="co">#&gt; Residual deviance:  83050  on 99997  degrees of freedom</span></span>
<span id="cb10-30"><a href="#cb10-30"></a><span class="co">#&gt; AIC: 83056</span></span>
<span id="cb10-31"><a href="#cb10-31"></a><span class="co">#&gt; </span></span>
<span id="cb10-32"><a href="#cb10-32"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></span></code></pre></div>
<p>Then, we plug our logit model into the <code>multivar_settings</code>. The code will then use our trained logit model on the variables we specified. Note that the name of the columns in the training set must match the name of the variables in the match datasets, with &quot;_compare&quot; at the end.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>result &lt;-<span class="st"> </span><span class="kw">merge_plus</span>(corp_data1, corp_data2, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;Country&quot;</span>, <span class="st">&quot;Company&quot;</span>), <span class="dt">unique_key_1 =</span> <span class="st">&quot;unique_key_1&quot;</span>,</span>
<span id="cb11-2"><a href="#cb11-2"></a>                        <span class="dt">unique_key_2 =</span> <span class="st">&quot;unique_key_2&quot;</span>, </span>
<span id="cb11-3"><a href="#cb11-3"></a>                     <span class="dt">match_type =</span> <span class="st">&quot;multivar&quot;</span>,</span>
<span id="cb11-4"><a href="#cb11-4"></a>                     <span class="dt">multivar_settings =</span> <span class="kw">list</span>(<span class="dt">logit =</span> logit_model, <span class="dt">compare_type =</span> <span class="kw">c</span>(<span class="st">&quot;indicator&quot;</span>, <span class="st">&quot;stringdist&quot;</span>),</span>
<span id="cb11-5"><a href="#cb11-5"></a>                        <span class="dt">wgts =</span> <span class="ot">NULL</span>),</span>
<span id="cb11-6"><a href="#cb11-6"></a>                        <span class="dt">suffixes =</span> <span class="kw">c</span>(<span class="st">&quot;_1&quot;</span>, <span class="st">&quot;_2&quot;</span>))</span>
<span id="cb11-7"><a href="#cb11-7"></a>result<span class="op">$</span>matches</span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">#&gt;     unique_key_1          Company_1 Country_1 State  SIC Revenue</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co">#&gt;  1:            1            Walmart       USA    OH 3300     485</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt;  2:            2   Bershire Hataway       USA       2222     223</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#&gt;  3:            3              Apple       USA    CA 3384     215</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt;  4:            4       Exxon Mobile       USA    TX 2222     205</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt;  5:            5          McKesson    Germany    MA  222     192</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt;  6:            6 UnitedHealth Group       USA    MA   NA     184</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co">#&gt;  7:            7         CVS Health       USA    RI 1112     177</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">#&gt;  8:            9               AT&amp;T       USA    TN 4000     163</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">#&gt;  9:            8     General Motors       USA    MI 2222     166</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co">#&gt; 10:           10 Ford Motor Company       USA    MI   NA     151</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="co">#&gt;              Company_2 Country_2 state_code SIC_code earnings unique_key_2</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="co">#&gt;  1:            Walmart       USA         OH     3380  490,000            1</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="co">#&gt;  2:  Bershire Hathaway       USA         NE     2220  220,000            2</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="co">#&gt;  3:     Apple Computer       USA         CA       NA  220,000            3</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="co">#&gt;  4: Exxon Mobile Inc.        USA         TX     2222  210,000            4</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="co">#&gt;  5:     McKesson Corp.                   MA     2222  190,000            5</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="co">#&gt;  6: UnitedHealth Group       USA         MA     1130  180,000            6</span></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="co">#&gt;  7:                CVS                   RI     1122  180,000            7</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="co">#&gt;  8:             AT &amp; T       USA         TN     4000  160,000            9</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="co">#&gt;  9:         Ford Motor       USA         MI     2222  150,000           10</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="co">#&gt; 10:         Ford Motor       USA         MI     2222  150,000           10</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="co">#&gt;     Country_compare Company_compare matchscore tier</span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="co">#&gt;  1:               1       1.0000000  0.9861508  all</span></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="co">#&gt;  2:               1       0.9882353  0.9853272  all</span></span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="co">#&gt;  3:               1       0.8714286  0.9740476  all</span></span>
<span id="cb11-34"><a href="#cb11-34"></a><span class="co">#&gt;  4:               1       0.9333333  0.9808013  all</span></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="co">#&gt;  5:               0       0.9285714  0.9660386  all</span></span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="co">#&gt;  6:               1       1.0000000  0.9861508  all</span></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="co">#&gt;  7:               0       0.8366667  0.9473611  all</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co">#&gt;  8:               1       0.9111111  0.9786024  all</span></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="co">#&gt;  9:               1       0.7333333  0.9496635  all</span></span>
<span id="cb11-40"><a href="#cb11-40"></a><span class="co">#&gt; 10:               1       0.9111111  0.9786024  all</span></span></code></pre></div>
<p>Note the last few columns in the data.table: we see the comparison metrics, just like in the linear combination version of <code>multivar_match</code>. But, note that instead of computing a 50/50 linear combination like before, we are now computing a matchscore as the fitted probability of a match based on our logit model. In this toy example, the coefficients are a little strange because of the random data we fed in. But, we see the behavior we’d expect: a higher company name comparison and a country match gives us a higher matchscore.</p>
</div>
</div>
<div id="summary-and-next-steps" class="section level1">
<h1>Summary and next steps</h1>
<p>We’ve covered the several different types of matching with <code>fedmatch</code>: exact matching, fuzzy matching, and multivar matching. Each match is useful in its own right, and they become even more useful when combined. That’s where the next step comes in: tier matching with the function <code>tier_match</code>.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
